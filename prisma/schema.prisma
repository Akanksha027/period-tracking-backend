// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // Direct connection for migrations
}

// User model - stores user profile information
model User {
  id            String         @id @default(uuid())
  email         String         @unique
  supabaseId    String?        @unique @map("supabase_id") // Supabase Auth user ID (legacy)
  clerkId       String?        @unique @map("clerk_id") // Clerk user ID
  name          String?
  
  // User type: 'self' = primary user who manages their data, 'other' = viewer
  userType      UserType       @default(SELF) @map("user_type")
  
  // For 'other' users: link to the 'self' user they're viewing
  viewedUserId  String?        @map("viewed_user_id") // ID of the 'self' user this 'other' user is viewing
  viewedUser    User?          @relation("UserViewer", fields: [viewedUserId], references: [id], onDelete: Cascade)
  viewers       User[]         @relation("UserViewer") // Reverse relation: all 'other' users viewing this 'self' user
  
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  
  // Data relationships - 'self' users own data, 'other' users view 'self' user's data
  periods       Period[]
  symptoms      Symptom[]
  moods         Mood[]
  notes         Note[]
  settings      UserSettings?
  otpCodes      OtpCode[]
  reminders     Reminder[]
  pushTokens    PushToken[]
  notificationLogs NotificationLog[]
  
  @@index([userType])
  @@index([viewedUserId])
  @@map("users")
}

// User type enum
enum UserType {
  SELF  // Primary user who manages their period data
  OTHER // Viewer who can only view a 'self' user's data
}

// User Settings
model UserSettings {
  id                    String    @id @default(uuid())
  userId                String    @unique @map("user_id")
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Initial setup data (for 'self' users)
  lastPeriodDate        DateTime? @map("last_period_date") // Last period start date
  periodDuration        Int?      @default(5) @map("period_duration") // How long periods last (days)
  averageCycleLength    Int       @default(28) @map("average_cycle_length") // Average cycle length (days)
  birthYear             Int?      @map("birth_year") // Birth year for age-related features
  
  // Settings
  averagePeriodLength   Int       @default(5) @map("average_period_length") // Alias for periodDuration (for backward compatibility)
  reminderEnabled       Boolean   @default(true) @map("reminder_enabled")
  reminderDaysBefore    Int       @default(3) @map("reminder_days_before")
  
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  
  @@map("user_settings")
}

// Period tracking
model Period {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  startDate   DateTime  @map("start_date")
  endDate     DateTime? @map("end_date")
  flowLevel   String?   @map("flow_level") // light, medium, heavy
  
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  @@index([userId])
  @@map("periods")
}

// Symptoms tracking
model Symptom {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  date        DateTime
  type        String    // cramps, headache, bloating, fatigue, etc.
  severity    Int       // 1-5 scale
  
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  @@index([userId, date])
  @@map("symptoms")
}

// Mood tracking
model Mood {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  date        DateTime
  type        String    // happy, sad, anxious, angry, calm, etc.
  
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  @@index([userId, date])
  @@map("moods")
}

// Notes
model Note {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  date        DateTime
  content     String
  
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  @@index([userId, date])
  @@map("notes")
}

// OTP codes for "login for someone else" flow
model OtpCode {
  id            String    @id @default(uuid())
  email         String
  userId        String?   @map("user_id")
  user          User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  otp           String
  verified      Boolean   @default(false)
  tempToken     String?   @map("temp_token")
  
  expiresAt     DateTime  @map("expires_at")
  tempTokenExpiresAt DateTime? @map("temp_token_expires_at")
  
  createdAt     DateTime  @default(now()) @map("created_at")
  
  @@index([email])
  @@index([userId])
  @@map("otp_codes")
}

// Reminders - AI-generated reminders for users
model Reminder {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  message     String    // AI-generated reminder message
  phase       String?   // Current cycle phase when reminder was sent
  cycleDay    Int?      @map("cycle_day") // Cycle day when reminder was sent
  
  sentAt      DateTime  @default(now()) @map("sent_at")
  
  createdAt   DateTime  @default(now()) @map("created_at")
  
  @@index([userId, sentAt])
  @@map("reminders")
}

model PushToken {
  id                  String    @id @default(uuid())
  userId              String    @map("user_id")
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expoPushToken       String    @unique @map("expo_push_token")
  deviceType          String    @map("device_type")
  mode                UserType  @map("mode")
  viewedUserId        String?   @map("viewed_user_id")
  timezoneOffsetMinutes Int     @default(0) @map("timezone_offset_minutes")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([userId])
  @@index([viewedUserId])
  @@map("push_tokens")
}

enum NotificationAudience {
  SELF
  VIEWER
}

enum NotificationCategory {
  PERIOD_COUNTDOWN
  PHASE_UPDATE
  SYMPTOM_PROMPT
  AI_TIP
  WORKOUT
  SYMPTOM_ALERT
  MOOD_SUPPORT
  VIEWER_TIP
}

model NotificationLog {
  id            String                 @id @default(uuid())
  userId        String                 @map("user_id")
  user          User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  audience      NotificationAudience   @map("audience")
  category      NotificationCategory   @map("category")
  message       String
  metadata      Json?                  @map("metadata")
  viewerUserId  String?                @map("viewer_user_id")
  sentAt        DateTime               @default(now()) @map("sent_at")
  createdAt     DateTime               @default(now()) @map("created_at")

  @@index([userId, audience, category, sentAt])
  @@index([viewerUserId])
  @@map("notification_logs")
}
